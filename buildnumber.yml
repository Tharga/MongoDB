parameters:
- name: majorMinor
  type: string

steps:
- pwsh: |
    $branchMaster = "refs/heads/master"
    $majorMinor = "${{ parameters.majorMinor }}"

    $orgUrl  = "$(System.CollectionUri)"
    $project = "$(System.TeamProject)"
    $defId   = "$(System.DefinitionId)"

    $uri = "$orgUrl$project/_apis/build/latest/$defId?branchName=$branchMaster&api-version=7.1-preview.1"

    $headers = @{
      Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN"
    }

    $latest = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get

    if (-not $latest -or -not $latest.buildNumber) {
      throw "Kunde inte läsa senaste master buildNumber."
    }

    $latestBuildNumber = $latest.buildNumber

    if ($latestBuildNumber -notmatch "^$([regex]::Escape($majorMinor))\.(\d+)$") {
      throw "Senaste master buildNumber ('$latestBuildNumber') matchar inte '$majorMinor.N'."
    }

    $patch = $Matches[1]

    if ("$(Build.SourceBranch)" -eq $branchMaster) {
      $nextPatch = ([int]$patch) + 1
      $newBuildNumber = "$majorMinor.$nextPatch"
    }
    else {
      $newBuildNumber = "$majorMinor.$patch-pre.$(Build.BuildId)"
    }

    Write-Host "Senaste master: $latestBuildNumber -> patch=$patch"
    Write-Host "Sätter build number till: $newBuildNumber"
    Write-Host "##vso[build.updatebuildnumber]$newBuildNumber"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  displayName: "Sätt buildnummer från senaste master"
