parameters:
- name: majorMinor
  type: string

steps:
- pwsh: |
    $branchMaster = "refs/heads/master"
    $majorMinor = "${{ parameters.majorMinor }}"

    $orgUrl  = $env:SYSTEM_COLLECTIONURI
    $project = $env:SYSTEM_TEAMPROJECT

    $defId = $env:DEF_ID
    if ([string]::IsNullOrWhiteSpace($defId) -or $defId -eq "-1") {
      throw "DEF_ID is empty or -1 (defId='$defId')."
    }

    $uri = "$orgUrl$project/_apis/build/builds?definitions=$defId&branchName=$branchMaster&`$top=50&queryOrder=finishTimeDescending&api-version=7.1"

    $headers = @{
      Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN"
    }

    $resp = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get
    if (-not $resp -or -not $resp.value -or $resp.count -lt 1) {
      throw "No builds found on master for definition $defId."
    }

    $releasePattern = "^$([regex]::Escape($majorMinor))\.(\d+)$"
    $anyPattern = "^$([regex]::Escape($majorMinor))\.(\d+)(?:-pre\.\d+)?$"

    $latestRelease = $resp.value | Where-Object { $_.buildNumber -match $releasePattern } | Select-Object -First 1
    $latestAny = $resp.value | Where-Object { $_.buildNumber -match $anyPattern } | Select-Object -First 1

    $picked = $latestRelease
    if (-not $picked) {
      $picked = $latestAny
    }

    if (-not $picked) {
      $first = $resp.value[0].buildNumber
      Write-Host "No master build found matching '$majorMinor.N' or '$majorMinor.N-pre.M'. First seen was '$first'. Starting fresh at $majorMinor.1."
      $patch = 0
    }
    else {
      $latestBuildNumber = $picked.buildNumber

      if ($latestBuildNumber -match $releasePattern) {
        $patch = $Matches[1]
      }
      elseif ($latestBuildNumber -match $anyPattern) {
        $patch = $Matches[1]
      }
      else {
        throw "Internal mismatch: '$latestBuildNumber' should have matched but did not."
      }
    }

    $nextPatch = ([int]$patch) + 1

    if ($env:BUILD_SOURCEBRANCH -eq $branchMaster) {
      $newBuildNumber = "$majorMinor.$nextPatch"
    }
    else {
      $preBase = "$majorMinor.$nextPatch-pre"
      $prePattern = "^$([regex]::Escape($preBase))\.(\d+)$"

      $allUri = "$orgUrl$project/_apis/build/builds?definitions=$defId&`$top=100&queryOrder=finishTimeDescending&api-version=7.1"
      $allResp = Invoke-RestMethod -Uri $allUri -Headers $headers -Method Get

      $maxCounter = $allResp.value |
        Where-Object { $_.buildNumber -match $prePattern } |
        ForEach-Object { [int]$Matches[1] } |
        Measure-Object -Maximum |
        Select-Object -ExpandProperty Maximum

      $preCounter = if ($maxCounter) { $maxCounter + 1 } else { 1 }
      $newBuildNumber = "$preBase.$preCounter"
    }

    if ($patch -ne 0) { Write-Host "Selected master base: $latestBuildNumber -> patch=$patch" }
    Write-Host "##vso[build.updatebuildnumber]$newBuildNumber"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    DEF_ID: $(System.DefinitionId)
  displayName: "Assign build version"
