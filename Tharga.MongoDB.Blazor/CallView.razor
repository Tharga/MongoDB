@using Microsoft.Extensions.Options
@using Tharga.Blazor
@using Tharga.Blazor.Framework.Buttons
@using Tharga.MongoDB.Configuration
@inject IDatabaseMonitor DatabaseMonitor;
@inject IOptions<DatabaseOptions> DatabaseOptions
@inject DialogService DialogService

@if (!DatabaseOptions.Value.Monitor.Enabled)
{
    <RadzenText>Database monitor is disabled.</RadzenText>
}
else if (_model == null)
{
    <Loading />
}
else
{
    <RadzenStack Orientation="Orientation.Vertical">

        <RadzenRow>
            <RadzenColumn>
                <RadzenStack Orientation="Orientation.Vertical">
                    <RadzenText TextStyle="TextStyle.Caption" Text="Type"/>
                    <RadzenSelectBar TValue="CallType" @bind-Value="@SelectedCallType" Change="@ReloadDataAsync" Style="margin-bottom: 6px;">
                        <Items>
                            <RadzenSelectBarItem Text="Last" Value="CallType.Last"/>
                            <RadzenSelectBarItem Text="Slow" Value="CallType.Slow"/>
                            <RadzenSelectBarItem Text="Ongoing" Value="CallType.Ongoing"/>
                        </Items>
                    </RadzenSelectBar>
                </RadzenStack>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenStack Orientation="Orientation.Vertical">
                    <RadzenText TextStyle="TextStyle.Caption" Text="Databases"/>
                    <RadzenDropDown Placeholder="Select databases" @bind-Value=@SelectedDatabases Data=@_databases Multiple=true Style="margin-bottom: 6px;" Change="@ReloadDataAsync" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

        <RadzenDataGrid Data="_model" TItem="CallInfo"
                        AllowFiltering="false" FilterMode="FilterMode.Simple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        AllowSorting="true"
                        AllowPaging="true" PageSize="8" PageSizeOptions="[8, 16, 32, 64]"
                        ShowPagingSummary="true" PagingSummaryFormat="@("{2:N0} calls, page {0} of {1}")"
                        CellRender="@OnCellRender">
            <Columns>
                <RadzenDataGridColumn Title="Start" Property="@nameof(CallInfo.StartTime)" SortOrder="SortOrder.Descending">
                    <Template>
                        <DateTimeView Date="@context.StartTime"/>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Title="Configuration" Property="@($"{nameof(CallInfo.Fingerprint)}.{nameof(CallInfo.Fingerprint.ConfigurationName)}")" Visible="@_showConfiguration" />
                <RadzenDataGridColumn Title="Database" Property="@($"{nameof(CallInfo.Fingerprint)}.{nameof(CallInfo.Fingerprint.DatabaseName)}")" />
                <RadzenDataGridColumn Title="Collection" Property="@($"{nameof(CallInfo.Fingerprint)}.{nameof(CallInfo.Fingerprint.CollectionName)}")" />
                <RadzenDataGridColumn Title="Function" Property="@nameof(CallInfo.FunctionName)"/>
                <RadzenDataGridColumn Title="Operation" Property="@nameof(CallInfo.Operation)"/>
                <RadzenDataGridColumn Title="Count" Property="@nameof(CallInfo.Count)"/>
                <RadzenDataGridColumn Title="Elapsed" Property="@nameof(CallInfo.Elapsed)" CssClass="final">
                    <Template>
                        <TimeSpanView TimeSpan="@context.Elapsed"/>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Title="Exception" Sortable="false" Filterable="false">
                    <Template>
                        @context.Exception?.Message
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Title="" Sortable="false" Width="60px;" Filterable="false">
                    <Template>
                        <StandardButton Icon="format_list_numbered" Click="@(() => ShowCallDialog(context))" Style="margin-right: 3px;" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenStack>
}

@code {
    private string[] _databases;
    private CallInfo[] _model;
    private bool _showConfiguration;
    private CallInfo[] _all;

    private CallType SelectedCallType { get; set; }
    private IEnumerable<string> SelectedDatabases { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        //TODO: Add event listener to update, especially ongoing calls.

        _all = DatabaseMonitor.GetCalls(CallType.Last).Union(DatabaseMonitor.GetCalls(CallType.Slow)).ToArray();
        _databases = _all.GroupBy(x => x.Fingerprint.DatabaseName).Select(x => x.First()).Select(x => x.Fingerprint.DatabaseName).Order().ToArray();

        await ReloadDataAsync();
        await base.OnParametersSetAsync();
    }

    void OnCellRender(DataGridCellRenderEventArgs<CallInfo> args)
    {
        var cssClass = args.Column.CssClass;
        if (string.IsNullOrEmpty(cssClass) || !cssClass.StartsWith("final")) return;

        string color = null;
        if (!args.Data.Final)
        {
            color = "lightyellow";
        }

        if (color is null) return;

        if (args.Attributes.TryGetValue("style", out var existing))
        {
            args.Attributes["style"] = existing + $"background-color: {color};";
        }
        else
        {
            args.Attributes.Add("style", $"background-color: {color};");
        }
    }

    private async Task ReloadDataAsync()
    {
        _all = DatabaseMonitor.GetCalls(SelectedCallType).ToArray();
        // _databases = _all.GroupBy(x => x.DatabaseName).Select(x => x.First()).Select(x => x.DatabaseName).Order().ToArray();
        _model = _all.Where(x => SelectedDatabases == null || !SelectedDatabases.Any() || SelectedDatabases.Contains(x.Fingerprint.DatabaseName)).ToArray();
        _showConfiguration = _model.GroupBy(x => x.Fingerprint.ConfigurationName).Count() > 1;
        StateHasChanged();
    }

    private async Task ShowCallDialog(CallInfo context)
    {
        var parameters = new Dictionary<string, object> { { "Key", context.Key } };
        var dialogOptions = new DialogOptions { Resizable = true, Draggable = true };
        var result = await DialogService.OpenAsync<CallDialog>($"{context.FunctionName} {context.Fingerprint.CollectionName}", parameters, dialogOptions);
        if (result != true) return;

        await ReloadDataAsync();
    }

}
