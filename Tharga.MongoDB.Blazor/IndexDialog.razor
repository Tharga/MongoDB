@using System.Text.Json
@using Tharga.Blazor.Framework.Buttons
@inject IDatabaseMonitor DatabaseMonitor
@inject NotificationService NotificationService
<pre>@_json</pre>

<ActionButton Text="Drop index" Click="DropIndex" Enabled="@CanUpdate" />
<ActionButton Text="Restore Index" Click="RestoreIndex" Enabled="@CanUpdate" />

@code {
    private string _json;

    [Parameter]
    public CollectionInfo CollectionInfo { get; set; }

    private bool CanUpdate => (CollectionInfo.Registration == Registration.Dynamic && CollectionInfo.Context != null) 
                              || (CollectionInfo.Registration == Registration.Static);

    protected override Task OnParametersSetAsync()
    {
        _json = JsonSerializer.Serialize(CollectionInfo, new JsonSerializerOptions { WriteIndented = true });

        return base.OnParametersSetAsync();
    }

    private async Task DropIndex()
    {
        try
        {
            var context = BuildDatabaseContext();
            await DatabaseMonitor.DropIndexAsync(context);

            await ReloadData();
            NotificationService.Notify(new NotificationMessage { Summary = "Indices has been dropped." });
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private DatabaseContext BuildDatabaseContext()
    {
        DatabaseContext context;
        switch (CollectionInfo.Registration)
        {
            case Registration.NotInCode:
                throw new NotSupportedException();
            case Registration.Static:
                context = new DatabaseContext { CollectionName = CollectionInfo.CollectionName, ConfigurationName = CollectionInfo.ConfigurationName };
                break;
            case Registration.Dynamic:
                context = CollectionInfo.Context;
                break;
            default:
                throw new ArgumentOutOfRangeException(nameof(CollectionInfo.Registration), $"Unknown {nameof(CollectionInfo.Registration)} {CollectionInfo.Registration}.");
        }

        return context;
    }

    private async Task RestoreIndex()
    {
        try
        {
            var context = BuildDatabaseContext();
            await DatabaseMonitor.RestoreIndexAsync(context);

            await ReloadData();
            NotificationService.Notify(new NotificationMessage { Summary = "Indices has been restored." });
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private async Task ReloadData()
    {
        var response = await DatabaseMonitor.GetInstancesAsync().SingleAsync(x => x.CollectionName == CollectionInfo.CollectionName);
        CollectionInfo = response;
        _json = JsonSerializer.Serialize(CollectionInfo, new JsonSerializerOptions { WriteIndented = true });
        StateHasChanged();
    }
}
