@using System.Text.Json
@using Tharga.Blazor.Framework.Buttons
@inject IDatabaseMonitor DatabaseMonitor
@inject NotificationService NotificationService
<pre>@_json</pre>

<ActionButton Text="Drop index" Click="DropIndex"/>
<ActionButton Text="Restore Index" Click="RestoreIndex" />

@code {
    private string _json;

    [Parameter]
    public CollectionInfo CollectionInfo { get; set; }

    protected override Task OnParametersSetAsync()
    {
        _json = JsonSerializer.Serialize(CollectionInfo, new JsonSerializerOptions { WriteIndented = true });

        return base.OnParametersSetAsync();
    }

    private async Task DropIndex()
    {
        try
        {
            //TODO: Handle part somehow. (Provide part in CollectionInfo)
            //TODO: Create an extension to CollectionInfo that can build DatabaseContext, if it is not provided as part directly.
            //TODO: Perhaps a context can also be created by a full mongodb-url?
            var context = new DatabaseContext { CollectionName = CollectionInfo.CollectionName, ConfigurationName = CollectionInfo.ConfigurationName };
            await DatabaseMonitor.DropIndexAsync(context);

            //TODO: Reload data and refresh dialog.
            NotificationService.Notify(new NotificationMessage { Summary = "Indices has been dropped." });
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private async Task RestoreIndex()
    {
        try
        {
            var context = new DatabaseContext { CollectionName = CollectionInfo.CollectionName, ConfigurationName = CollectionInfo.ConfigurationName };
            await DatabaseMonitor.RestoreIndexAsync(context);

            //TODO: Reload data and refresh dialog.
            NotificationService.Notify(new NotificationMessage { Summary = "Indices has been restored." });
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }
}
