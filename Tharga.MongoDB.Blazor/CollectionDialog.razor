@using Tharga.Blazor.Framework.Buttons
@using Tharga.Toolkit
@implements IDisposable
@inject IDatabaseMonitor DatabaseMonitor
@inject NotificationService NotificationService
@inject DialogService DialogService

@if (_model == null)
{
    <Tharga.Blazor.Loading />
}
else
{
    <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Configuration"/>
                <RadzenText Text="@_model.ConfigurationName"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Database"/>
                <RadzenText Text="@_model.DatabaseName" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Collection"/>
                <RadzenText Text="@_model.CollectionName" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Source"/>
                <RadzenText Text="@($"{_model.Source}")" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Registration"/>
                <RadzenText Text="@($"{_model.Registration}")" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Types" />
                <RadzenText Text="@($"{string.Join(", ", _model.Types)}")" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Access Count"/>
                <RadzenText Text="@($"{_model.AccessCount:N0}")" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Document Count"/>
                <RadzenText Text="@(_model.DocumentCount != null ? $"{_model.DocumentCount.Count:N0}" : "â€”")" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Size"/>
                <RadzenText Text="@_model.Size.ToReadableByteSize()" />
            </RadzenColumn>
        </RadzenRow>

        @if (_model.Clean != null)
        {
            <RadzenRow>
                <RadzenColumn>
                    <RadzenText TextStyle="TextStyle.Caption" Text="Last Cleaned"/>
                    <RadzenText Text="@_model.Clean.CleanedAt.ToLocalDurationString()" title="@_model.Clean.CleanedAt.ToLocalDateTimeString()" />
                </RadzenColumn>
                <RadzenColumn>
                    <RadzenText TextStyle="TextStyle.Caption" Text="Documents Cleaned"/>
                    <RadzenText Text="@($"{_model.Clean.DocumentsCleaned:N0}")" />
                </RadzenColumn>
                <RadzenColumn>
                    <RadzenText TextStyle="TextStyle.Caption" Text="Fingerprint Match"/>
                    <RadzenText Text="@(FingerprintMatch ? "Current" : "Outdated")" Style="@(FingerprintMatch ? "" : "color: orange; font-weight: bold;")" />
                </RadzenColumn>
            </RadzenRow>
        }

        @if (_indexModel.Any())
        {
            <RadzenText TextStyle="TextStyle.Caption" Text="Indices"/>
            <RadzenDataGrid Data="_indexModel" TItem="IndexModel"
                            CellRender="@OnCellRender">
                <Columns>
                    <RadzenDataGridColumn Title="Name" Property="@nameof(IndexModel.Name)"/>
                    <RadzenDataGridColumn Title="Defined" CssClass="css-defined">
                        <Template>
                            <RadzenText Text="@($"{(context.Defined?.IsUnique ?? false ? "[Unique] " : "")}{string.Join(", ", context.Defined?.Fields ?? [])}")"/>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Title="Current" CssClass="css-current">
                        <Template>
                            <RadzenText Text="@($"{(context.Current?.IsUnique ?? false ? "[Unique] " : "")}{string.Join(", ", context.Current?.Fields ?? [])}")" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn>
                        <Template>
                            <RadzenButton Icon="compare_arrows" Text="Duplicates" Click="@(() => Show(context))" Disabled="@(!CanTouch)" Visible="@(context.Defined?.IsUnique == true && context.Differs())" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
            <ActionButton Text="Touch" Icon="touch_app" Click="TouchCollection" Enabled="@CanTouch" />
            <ActionButton Text="Drop index" Icon="delete" Click="DropIndex" Enabled="@CanDrop" />
            <ActionButton Text="Restore Index" Icon="construction" Click="RestoreIndex" Enabled="@CanRestore" />
            <ActionButton Text="Clean" Icon="cleaning_services" Click="CleanCollection" Enabled="@CanClean" />
        </RadzenStack>

    </RadzenStack>
}

@code {
    private CollectionInfo _model;
    private IndexModel[] _indexModel;

    [Parameter]
    public CollectionFingerprint Fingerprint { get; set; }

    private bool CanTouch => _model != null && _model.Registration != Registration.NotInCode;
    private bool CanDrop => CanTouch && (_model.Index?.Current?.Any() ?? false);
    private bool CanRestore => CanTouch && _indexModel.Any(x => !x.EqualFields);
    private bool CanClean => CanTouch;
    private bool FingerprintMatch => _model?.Clean != null && _model.Clean.SchemaFingerprint == _model.CurrentSchemaFingerprint;

    protected override async Task OnInitializedAsync()
    {
        DatabaseMonitor.CollectionInfoChangedEvent += OnCollectionInfoChanged;
        await base.OnInitializedAsync();
    }

    public void Dispose()
    {
        DatabaseMonitor.CollectionInfoChangedEvent -= OnCollectionInfoChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadDataAsync();
        _ = Task.Run(() => DatabaseMonitor.RefreshStatsAsync(Fingerprint));
        await base.OnParametersSetAsync();
    }

    private async void OnCollectionInfoChanged(object sender, CollectionInfoChangedEventArgs e)
    {
        if (e.CollectionInfo.Key != Fingerprint?.Key) return;
        _model = e.CollectionInfo;
        _indexModel = _model.ToIndexModel().ToArray();
        await InvokeAsync(StateHasChanged);
    }

    private async Task TouchCollection()
    {
        try
        {
            await DatabaseMonitor.TouchAsync(_model);

            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = "Collection has been touched." });
        }
        catch (Exception e)
        {
            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private async Task DropIndex()
    {
        try
        {
            var result = await DialogService.Confirm("Indicies will be dropped.", "Confirm drop indicies");
            if (result != true) return;

            var response = await DatabaseMonitor.DropIndexAsync(_model);
            var dropCount = response.Before - response.After;

            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = "Indices has been dropped.", Detail = $"Dropped {dropCount} indices. There are {response.After} indices left." });
        }
        catch (Exception e)
        {
            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private async Task RestoreIndex()
    {
        try
        {
            var result = await DialogService.Confirm("Indicies will be restored.", "Confirm restore indicies");
            if (result != true) return;

            await DatabaseMonitor.RestoreIndexAsync(_model, true);

            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = "Indices has been restored." });
        }
        catch (Exception e)
        {
            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private async Task CleanCollection()
    {
        try
        {
            var result = await DialogService.Confirm($"All {(_model.DocumentCount != null ? $"{_model.DocumentCount.Count:N0}" : "unknown number of")} documents in the collection will be cleaned (including GUID format). This might take time to perform.", "Confirm clean collection");
            if (result != true) return;

            var cleanInfo = await DatabaseMonitor.CleanAsync(_model, cleanGuids: true);

            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = "Collection has been cleaned.", Detail = $"{cleanInfo.DocumentsCleaned} documents cleaned." });
        }
        catch (Exception e)
        {
            await ReloadDataAsync();
            NotificationService.Notify(new NotificationMessage { Summary = e.Message, Detail = $"{e.StackTrace}", Severity = NotificationSeverity.Error });
        }
    }

    private async Task ReloadDataAsync()
    {
        var response = await DatabaseMonitor.GetInstanceAsync(Fingerprint);

        _indexModel = response.ToIndexModel().ToArray();
        _model = response;

        StateHasChanged();
    }

    void OnCellRender(DataGridCellRenderEventArgs<IndexModel> args)
    {
        var cssClass = args.Column.CssClass;
        if (string.IsNullOrEmpty(cssClass)) return;

        if (cssClass.StartsWith("css-current"))
        {
            string color = null;
            if (args.Data.Current == null)
            {
                color = "pink";
            }
            else if (args.Data.Defined != null && !args.Data.EqualFields)
            {
                color = "pink";
            }

            SetColor(args, color);
        }
        else if (cssClass.StartsWith("css-defined"))
        {
            string color = null;
            if (args.Data.Defined == null)
            {
                color = "pink";
            }

            SetColor(args, color);
        }
    }

    private static void SetColor(DataGridCellRenderEventArgs<IndexModel> args, string color)
    {
        if (color is null) return;

        if (args.Attributes.TryGetValue("style", out var existing))
        {
            args.Attributes["style"] = existing + $"background-color: {color};";
        }
        else
        {
            args.Attributes.Add("style", $"background-color: {color};");
        }
    }

    private async Task Show(IndexModel context)
    {
        var items = (await DatabaseMonitor.GetIndexBlockersAsync(_model, context.Name)).ToArray();
        if (items.Any())
            await DialogService.Alert($"{string.Join('\n', items.Select(x => $"{x.First()} == {x.Last()}"))}", "Duplicates");
        else
            await DialogService.Alert($"No duplicate documents by index '{context.Name}' found.", "Duplicates");
    }

}
