@using Tharga.Blazor
@inject ICallLibrary CallLibrary

@if (_model == null)
{
    <Tharga.Blazor.Loading />
}
else
{
    <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Configuration"/>
                <RadzenText Text="@_model.Fingerprint.ConfigurationName"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Database"/>
                <RadzenText Text="@_model.Fingerprint.DatabaseName" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Collection"/>
                <RadzenText Text="@_model.Fingerprint.CollectionName" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="FunctionName" />
                <RadzenText Text="@_model.FunctionName"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Operation" />
                <RadzenText Text="@($"{_model.Operation}")"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Exception" />
                <RadzenText Text="@($"{_model.Exception?.Message}")" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Time" />
                <DateTimeView Date="@_model.StartTime" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Count" />
                <RadzenText Text="@($"{_model.Count}")" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Elapsed" />
                <RadzenText Text="@($"{_model.Elapsed?.Milliseconds:F2} ms")" />
            </RadzenColumn>
        </RadzenRow>
        @if (_model.Steps != null && _model.Steps.Count > 0)
        {
            <RadzenText TextStyle="TextStyle.Caption" Text="Steps" />
            <RadzenDataGrid Data="_model.Steps" TItem="CallStepInfo" AllowSorting="false" AllowPaging="false" AllowFiltering="false" Density="Density.Compact">
                <Columns>
                    <RadzenDataGridColumn TItem="CallStepInfo" Property="Step" Title="Step" />
                    <RadzenDataGridColumn TItem="CallStepInfo" Title="Duration (ms)" TextAlign="TextAlign.Right">
                        <Template Context="step">
                            @($"{step.Delta.TotalMilliseconds:F2}")
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CallStepInfo" Property="Message" Title="Message" Visible="@(_model.Steps.Any(x => !string.IsNullOrEmpty(x.Message)))" />
                </Columns>
            </RadzenDataGrid>
        }
        @if (!string.IsNullOrEmpty(_model.FilterJson))
        {
            <RadzenText TextStyle="TextStyle.Caption" Text="Filter" />
            <pre style="background:#f5f5f5;padding:0.5rem;border-radius:4px;overflow-x:auto;font-size:0.8rem;white-space:pre-wrap;word-break:break-all;">@_model.FilterJson</pre>
        }
    </RadzenStack>
}

@code {
    private CallInfo _model;

    [Parameter]
    public Guid Key { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadDataAsync();
        await base.OnParametersSetAsync();
    }

    private async Task ReloadDataAsync()
    {
        _model = CallLibrary.GetCall(Key);
        StateHasChanged();
    }
}
