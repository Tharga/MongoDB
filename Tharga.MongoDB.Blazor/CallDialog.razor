@inject ICallLibrary CallLibrary

@if (_model == null)
{
    <Tharga.Blazor.Loading />
}
else
{
    <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Configuration"/>
                <RadzenText Text="@_model.Fingerprint.ConfigurationName"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Database"/>
                <RadzenText Text="@_model.Fingerprint.DatabaseName" />
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Collection"/>
                <RadzenText Text="@_model.Fingerprint.CollectionName" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="FunctionName" />
                <RadzenText Text="@_model.FunctionName"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Operation" />
                <RadzenText Text="@($"{_model.Operation}")"/>
            </RadzenColumn>
            <RadzenColumn>
                <RadzenText TextStyle="TextStyle.Caption" Text="Count" />
                <RadzenText Text="@($"{_model.Count}")" />
            </RadzenColumn>
        </RadzenRow>
        @if (_model.Steps != null && _model.Steps.Count > 0)
        {
            <RadzenText TextStyle="TextStyle.Caption" Text="Steps" />
            <RadzenDataGrid Data="_model.Steps" TItem="CallStepInfo" AllowSorting="false" AllowPaging="false" AllowFiltering="false" Density="Density.Compact">
                <Columns>
                    <RadzenDataGridColumn TItem="CallStepInfo" Property="Step" Title="Step" />
                    <RadzenDataGridColumn TItem="CallStepInfo" Title="Duration (ms)">
                        <Template Context="step">
                            @($"{step.Delta.TotalMilliseconds:F2}")
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CallStepInfo" Property="Message" Title="Message" />
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenStack>
}

@code {
    private CallInfo _model;

    [Parameter]
    public Guid Key { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadDataAsync();
        await base.OnParametersSetAsync();
    }

    private async Task ReloadDataAsync()
    {
        _model = CallLibrary.GetCall(Key);
        StateHasChanged();
    }
}
