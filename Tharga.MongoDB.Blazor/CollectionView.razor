@using Tharga.Blazor
@using Tharga.Blazor.Framework.Buttons
@using Tharga.MongoDB
@using Tharga.Toolkit
@inject IDatabaseMonitor DatabaseMonitor;
@inject DialogService DialogService

@if (_model == null)
{
    <Loading />
}
else
{
    <RadzenDataGrid Data="_model" TItem="CollectionInfo"
                    AllowFiltering="false" FilterMode="FilterMode.Simple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    AllowSorting="true"
                    AllowPaging="true" PageSize="8" PageSizeOptions="[8, 16, 32, 64]"
                    ShowPagingSummary="true" PagingSummaryFormat="@("{2:N0} collections, page {0} of {1}")"
                    CellRender="@OnCellRender">
        <Columns>
            <RadzenDataGridColumn Title="Configuration" Property="@nameof(CollectionInfo.ConfigurationName)" Visible="@_showConfiguration"/>
            <RadzenDataGridColumn Title="Database" Property="@nameof(CollectionInfo.DatabaseName)" />
            <RadzenDataGridColumn Title="Collection" Property="@nameof(CollectionInfo.CollectionName)"/>
            <RadzenDataGridColumn Title="Source" Property="@nameof(CollectionInfo.Source)"/>
            <RadzenDataGridColumn Title="Registration" Property="@nameof(CollectionInfo.Registration)"/>
            <RadzenDataGridColumn Title="AccessCount" Property="@nameof(CollectionInfo.AccessCount)" TextAlign="TextAlign.Right" FormatString="{0:N0}"/>
            <RadzenDataGridColumn Title="DocumentCount" Property="@nameof(CollectionInfo.DocumentCount)" TextAlign="TextAlign.Right" CssClass="count">
                <Template>
                    @if (context.DocumentCount.IsValid)
                    {
                        <RadzenText Text="@($"{context.DocumentCount.Count:N0}")"/>
                    }
                    else
                    {
                        <RadzenText Text="@($"{context.DocumentCount.Count:N0} (Virtual count is {context.DocumentCount.Virtual:N0})")"/>
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Title="Size" Property="@nameof(CollectionInfo.Size)" TextAlign="TextAlign.Right">
                <Template>
                    @context.Size.ToReadableByteSize()
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Title="Index" Sortable="false" Width="120px;">
                <Template>
                    @if (context.Index.Defined != null)
                    {
                        <StandardButton Icon="format_list_numbered" ButtonStyle="@(context.Index.Defined.SequenceEqual(context.Index.Current) ? ButtonStyle.Base : ButtonStyle.Warning)" Click="@(() => ShowIndexDialog(context))" Style="margin-right: 3px;" />
                    }
                    @if (context.Registration != Registration.NotInCode && context.AccessCount == 0)
                    {
                        <StandardButton Icon="touch_app" Click="@(() => TouchCollection(context))" />
                    }
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    private CollectionInfo[] _model;
    private bool _showConfiguration;

    [Parameter]
    public bool FullDatabaseScan { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadData();
        _showConfiguration = _model.GroupBy(x => x.ConfigurationName).Count() > 1;

        await base.OnParametersSetAsync();
    }

    private async Task TouchCollection(CollectionInfo context)
    {
        await DatabaseMonitor.TouchAsync(context);
        await ReloadData();
    }

    private async Task ShowIndexDialog(CollectionInfo context)
    {
        var result = await DialogService.OpenAsync<CollectionDialog>(context.CollectionName, new Dictionary<string, object>
        {
            { "CollectionInfo", context }
        }, new DialogOptions { Resizable = true, Draggable = true });

        if (result != true) return;

        await ReloadData();
    }

    private async Task ReloadData()
    {
        _model = await DatabaseMonitor.GetInstancesAsync(FullDatabaseScan).ToArrayAsync();
        StateHasChanged();
    }

    void OnCellRender(DataGridCellRenderEventArgs<CollectionInfo> args)
    {
        var cssClass = args.Column.CssClass;
        if (string.IsNullOrEmpty(cssClass) || !cssClass.StartsWith("count")) return;

        string color = null;
        if (!args.Data.DocumentCount.IsValid)
        {
            color = "pink";
        }
        else if (args.Data.DocumentCount.Virtual == null)
        {
            color = "lightyellow";
        }

        if (color is null) return;

        if (args.Attributes.TryGetValue("style", out var existing))
        {
            args.Attributes["style"] = existing + $"background-color: {color};";
        }
        else
        {
            args.Attributes.Add("style", $"background-color: {color};");
        }
    }
}
